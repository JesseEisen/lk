---
title: 21B07
subtitle: python hard way
category: "python"
date: 2021-01-21
---

[[toc]]

---

## command line argument parse

使用 [[click](https://click.palletsprojects.com/en/7.x/)] 作为解析库，可以方便的实现子命令操作。整理一些使用中遇到的问题。

+ 对 argument 进行注释

使用多行注释的方式 `""" xxx """`。但是 click 默认是现在在统一行，去除掉了换行的操作。所以在有多参数的情况下显示比较乱。解决方式是：

```
@click.command()
@click.argument('gt', type=click.Path(exists=True))
@click.argument('prefix', type=click.Path(exists=True))
def execute(gt, prefix):
    """
       \b 
       explain the command usage
       gt: xxxx
       prefix: xxxxx
    """
```


## progess bar

使用 [[tqdm](https://github.com/tqdm/tqdm)] 搭配各种场景使用，比如在 requests 中显示现在的进度时，可以有如下的方式：

```
r = requests.get(url, stream=True, allow_redirects=True)
... # status code check 
path = pathlib.Path(filename).expanduser().resolve()
path.parent.mkdir(parents=True, exist_ok=True)

desc = filename.ljust(22, ' ') # 22 is the lenght bigger than filename, should change
r.raw.read = functools.partial(r.raw.read, decode_content=True)  # Decompress if needed
with tqdm.tqdm.wrapattr(r.raw, "read", total=file_size, desc=desc) as r_raw:
     with path.open("wb") as f:
            shutil.copyfileobj(r_raw, f)
```

同时也可以在命令行中使用：

```
find . -name '*.py' -type f -exec cat \{} \; \
  | tqdm --unit loc --unit_scale --total 857366 >> /dev/null
100%|█████████████████████████████████| 857K/857K [00:04<00:00, 246Kloc/s]
```

更多使用参考文档 [[tqdm documention](https://tqdm.github.io/docs)] 。


## requirements.txt

这个文件可以用于python项目初始化时安装依赖使用。可以通过两种方式获取到：

```
# 获取完整的依赖环境
$ pip3 freeze > requirements.txt

# 获取必要的依赖
$ pip install pipreqs
$ pipreqs .

# 使用
$ pip install -r requirements.txt
```


## tar file

获取 tar.gz 文件中的顶层目录的名称，使用下面简单的方式：

```
archive = tarfile.open(filepath, mode='r')
print os.path.commonprefix(archive.getnames())
```